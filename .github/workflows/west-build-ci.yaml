name: Build and Test Firmware

on:
  push:
    paths:
      - 'sw/**'
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'sw/**'

permissions:
  contents: write
  packages: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.27.4

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup west workspace
        run: |
          west init -l sw/jtag-switch
          west update --narrow -o=--depth=1

      - name: Build all targets
        run: |
          cd sw
          for board in frdm_k64f frdm_k64f_virtual frdm_mcxc444; do
            echo "::group::Building $board"
            west build -p -b $board jtag-switch
            mkdir -p artifacts/$board
            cp build/zephyr/zephyr.elf artifacts/$board/
            echo "::endgroup::"
          done

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-all
          path: sw/artifacts/
          retention-days: 7

  test-renode:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-all
          path: sw/artifacts/

      - name: Setup virtual firmware
        run: |
          mkdir -p sw/build/zephyr
          cp sw/artifacts/frdm_k64f_virtual/zephyr.elf sw/build/zephyr/
          ls -la sw/build/zephyr/

      - name: Cache Renode portable
        id: cache-renode
        uses: actions/cache@v4
        with:
          path: renode_portable
          key: renode-1.16.0-linux-portable

      - name: Install Renode
        if: steps.cache-renode.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/renode/renode/releases/download/v1.16.0/renode-1.16.0.linux-portable.tar.gz
          mkdir -p renode_portable
          tar xzf renode-1.16.0.linux-portable.tar.gz -C renode_portable --strip-components=1

      - name: Verify Renode installation
        run: ./renode_portable/renode --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install test dependencies
        run: pip install pytest pytest-timeout colorama

      - name: Run Renode simulation tests
        env:
          RENODE_PATH: ${{ github.workspace }}/renode_portable/renode
        working-directory: sw/jtag-switch/tests
        run: pytest test_renode.py -v --tb=short --timeout=120 --junitxml=renode-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renode-test-results
          path: sw/jtag-switch/tests/renode-results.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: sw/jtag-switch/tests/renode-results.xml
          check_name: Renode Simulation Tests
          fail_on_failure: true
