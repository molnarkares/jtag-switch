name: Renode Simulation Tests

on:
  workflow_run:
    workflows: ["Build Firmware"]
    types:
      - completed

permissions:
  contents: read
  checks: write
  actions: read

jobs:
  test-renode:
    runs-on: ubuntu-latest
    # Only run if the build workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Download virtual firmware artifact
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: west-build-ci.yaml
          run_id: ${{ github.event.workflow_run.id }}
          name: firmware-frdm_k64f_virtual
          path: sw/build/zephyr/

      - name: Verify firmware downloaded
        run: |
          ls -la sw/build/zephyr/
          test -f sw/build/zephyr/zephyr.elf

      - name: Cache Renode portable
        id: cache-renode
        uses: actions/cache@v4
        with:
          path: renode_portable
          key: renode-1.16.0-linux-portable

      - name: Install Renode
        if: steps.cache-renode.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/renode/renode/releases/download/v1.16.0/renode-1.16.0.linux-portable.tar.gz
          mkdir -p renode_portable
          tar xzf renode-1.16.0.linux-portable.tar.gz -C renode_portable --strip-components=1

      - name: Verify Renode installation
        run: ./renode_portable/renode --version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      - name: Install test dependencies
        run: pip install pytest pytest-timeout colorama

      - name: Run Renode simulation tests
        env:
          RENODE_PATH: ${{ github.workspace }}/renode_portable/renode
        working-directory: sw/jtag-switch/tests
        run: pytest test_renode.py -v --tb=short --timeout=120 --junitxml=renode-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renode-test-results
          path: sw/jtag-switch/tests/renode-results.xml
          retention-days: 30

      - name: Publish test results
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: sw/jtag-switch/tests/renode-results.xml
          check_name: Renode Simulation Tests
          fail_on_failure: true
          commit: ${{ github.event.workflow_run.head_sha }}
